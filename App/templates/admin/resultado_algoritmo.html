{% extends "layouts/base.html" %}
{% load i18n static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <h6>Resultado del Algoritmo Genético</h6>
                </div>
                <div class="row justify-content-center">
                    <div class="col-12 col-md-6">
                        <div class="d-flex justify-content-between">
                            <form method="post" action="{% url 'guardar_horarios' %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success mt-3">Guardar Horarios</button>
                            </form>
                            <a href="javascript:history.back()" class="btn btn-secondary mt-3">Regresar</a>
                            <button id="reloadAlgoritmo" class="btn btn-primary mt-3">Recargar Algoritmo</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Curso - Grupo</th>
                                    <th>Estudiante</th>
                                    <th>Jurado 1</th>
                                    <th>Jurado 2</th>
                                    <th>Asesor</th>
                                    <th style="max-width: 200px;">Título</th>
                                    <th>Fecha</th>
                                    <th>Hora Inicio</th>
                                    <th>Hora Fin</th>
                                </tr>
                            </thead>
                            <tbody id="resultado-tabla">
                                {% for sustentacion in mejor_horario %}
                                    <tr>
                                        <td>{{ sustentacion.cursos_grupos.curso }} - {{ sustentacion.cursos_grupos.grupo }}</td>
                                        <td>{{ sustentacion.estudiante }}</td>
                                        <td>{{ sustentacion.jurado1 }}</td>
                                        <td>{{ sustentacion.jurado2 }}</td>
                                        <td>{{ sustentacion.asesor }}</td>
                                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{ sustentacion.titulo }}</td>
                                        <td>{{ sustentacion.fecha }}</td>
                                        <td>{{ sustentacion.hora_inicio }}</td>
                                        <td>{{ sustentacion.hora_fin }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="loadingModal" tabindex="9999999" role="dialog" aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <p>Generando horario, por favor espere...</p>
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .modal-backdrop {
        z-index: 1040 !important;
    }
    .modal-content {
        z-index: 1100 !important;
    }
    #loadingModal {
        z-index: 1100 !important;
    }
</style>

<script>
    document.getElementById('reloadAlgoritmo').addEventListener('click', function() {
        // Mostrar el modal
        $('#loadingModal').modal('show');

        fetch("{% url 'ejecutar_algoritmo' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                let tbody = document.getElementById('resultado-tabla');
                tbody.innerHTML = '';

                let groupedRows = {};

                data.mejor_horario.forEach(function(sustentacion) {
                    let courseGroup = `${sustentacion.cursos_grupos.curso} - ${sustentacion.cursos_grupos.grupo}`;
                    if (!groupedRows[courseGroup]) {
                        groupedRows[courseGroup] = [];
                    }
                    let row = `
                        <tr>
                            <td>${sustentacion.cursos_grupos.curso} - ${sustentacion.cursos_grupos.grupo}</td>
                            <td>${sustentacion.estudiante}</td>
                            <td>${sustentacion.jurado1}</td>
                            <td>${sustentacion.jurado2}</td>
                            <td>${sustentacion.asesor}</td>
                            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${sustentacion.titulo}</td>
                            <td>${sustentacion.fecha}</td>
                            <td>${sustentacion.hora_inicio}</td>
                            <td>${sustentacion.hora_fin}</td>
                        </tr>
                    `;
                    groupedRows[courseGroup].push({
                        row: row,
                        fecha: sustentacion.fecha,
                        hora_inicio: sustentacion.hora_inicio
                    });
                });

                Object.keys(groupedRows).forEach(function(courseGroup) {
                    // Ordenar las filas por fecha y hora
                    groupedRows[courseGroup].sort((a, b) => {
                        let fechaA = new Date(a.fecha + ' ' + a.hora_inicio);
                        let fechaB = new Date(b.fecha + ' ' + b.hora_inicio);
                        return fechaA - fechaB;
                    });

                    let headerRow = `
                        <tr>
                            <th colspan="9">${courseGroup}</th>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', headerRow);

                    groupedRows[courseGroup].forEach(function(item) {
                        tbody.insertAdjacentHTML('beforeend', item.row);
                    });
                });
            } else {
                alert('Error al ejecutar el algoritmo: ' + data.message);
            }
            // Ocultar el modal
            $('#loadingModal').modal('hide');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al ejecutar el algoritmo: ' + error.message);
            // Ocultar el modal
            $('#loadingModal').modal('hide');
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var table = document.querySelector('.table');
        var columnIndex = Array.from(table.querySelector('thead').querySelectorAll('th')).findIndex(th => th.textContent.trim() === 'Curso - Grupo');
        var groupedRows = {};

        Array.from(table.querySelectorAll('tbody tr')).forEach(function(row) {
            var courseGroup = row.querySelectorAll('td')[columnIndex].textContent.trim();
            if (!groupedRows[courseGroup]) {
                groupedRows[courseGroup] = [];
            }
            groupedRows[courseGroup].push({
                row: row,
                fecha: row.querySelectorAll('td')[6].textContent.trim(),
                hora_inicio: row.querySelectorAll('td')[7].textContent.trim()
            });
        });

        table.querySelector('tbody').innerHTML = '';

        Object.keys(groupedRows).forEach(function(courseGroup) {
            // Ordenar las filas por fecha y hora
            groupedRows[courseGroup].sort((a, b) => {
                let fechaA = new Date(a.fecha + ' ' + a.hora_inicio);
                let fechaB = new Date(b.fecha + ' ' + b.hora_inicio);
                return fechaA - fechaB;
            });

            var headerRow = document.createElement('tr');
            var headerCell = document.createElement('th');
            headerCell.textContent = courseGroup;
            headerCell.setAttribute('colspan', table.querySelectorAll('thead th').length);
            headerRow.appendChild(headerCell);
            table.querySelector('tbody').appendChild(headerRow);

            groupedRows[courseGroup].forEach(function(item) {
                table.querySelector('tbody').appendChild(item.row);
            });
        });
    });
</script>

{% endblock %}
